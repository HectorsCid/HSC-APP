<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Repositorio de Cotizaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#9ca3af;
      --line:rgba(255,255,255,.08); --accent:#22c55e; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Segoe UI, Roboto, system-ui, -apple-system, sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    h1{font-size:1.2rem;margin:4px 0 14px;text-align:center}
    .toolbar{display:flex;gap:10px;align-items:center;margin:6px 0 12px}
    .search{flex:1;display:flex;align-items:center;gap:8px;background:#07101c;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
    .search input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:16px}
    .btn{border:1px solid var(--line);background:#0b1626;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:active{transform:scale(.99)}
    .fs{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line); border-radius:var(--radius);
      overflow:hidden;
    }
    .row{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
    .row:last-child{border-bottom:none}
    .folder{background:var(--card);cursor:pointer;user-select:none}
    .folder:hover{background:#0e1a2c}
    .name{flex:1;display:flex;align-items:center;gap:10px}
    .badge{font-size:.75rem;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .chev{transition:transform .2s ease}
    .open .chev{transform:rotate(90deg)}
    .files{display:none;background:#08111d}
    .open + .files{display:block}
    .file{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px dashed var(--line)}
    .file:last-child{border-bottom:none}
    .file a{color:#93c5fd;text-decoration:none}
    .file a:hover{text-decoration:underline}
    .actions{margin-top:14px;text-align:center}
    .back{display:inline-block;text-decoration:none}
    .hint{font-size:.85rem;color:var(--muted);text-align:center;margin:6px 0 12px}
    /* Icons */
    .ico{width:20px;height:20px;flex:0 0 20px}
    @media (min-width:700px){
      .row{padding:14px 18px}
      .file{padding:12px 22px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Repositorio de Cotizaciones</h1>
    <div class="hint">Toca una carpeta para ver sus PDFs. Busca por cliente o por nombre de archivo.</div>

    <div class="toolbar">
      <div class="search">
        <!-- lupa -->
        <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="q" type="search" placeholder="Buscar cliente o archivo..." oninput="doFilter()">
      </div>
      <button class="btn" onclick="toggleAll(true)">Expandir</button>
      <button class="btn" onclick="toggleAll(false)">Colapsar</button>
    </div>

    <div class="fs" id="fs">
      {% for cliente, archivos in estructura.items() %}
      <div class="row folder" data-cliente="{{ cliente | lower }}">
        <!-- chevron -->
        <svg class="ico chev" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <!-- folder -->
        <svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4l2 2h8a2 2 0 0 1 2 2v9a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h5z"/></svg>
        <div class="name">
          <strong>{{ cliente }}</strong>
        </div>
        <span class="badge">{{ archivos|length }} archivo{{ 's' if archivos|length != 1 }}</span>
        <a href="{{ url_for('abrir_drive_cliente', cliente=cliente) }}" class="btn" style="margin-left:8px" title="Abrir carpeta en Drive">Drive ↗</a>

      </div>
      <div class="files" data-files-of="{{ cliente | lower }}">
        {% for archivo in archivos %}
        <div class="file" data-file="{{ (cliente ~ ' ' ~ archivo) | lower }}">
          <!-- pdf icon -->
          <svg class="ico" viewBox="0 0 24 24" fill="none">
            <path d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="1.2"/>
            <path d="M14 3v5h5" stroke="currentColor" stroke-width="1.2"/>
            <text x="8" y="17" font-size="6" fill="currentColor">PDF</text>
          </svg>
          <a href="{{ url_for('static', filename='cotizaciones/' + cliente + '/' + archivo) }}" target="_blank" rel="noopener">
            {{ archivo }}
          </a>
          <span class="badge">ver</span>
          <a href="{{ url_for('static', filename='cotizaciones/' + cliente + '/' + archivo) }}" download style="margin-left:auto" title="Descargar">⬇</a>
        </div>
        {% endfor %}
      </div>
      {% endfor %}
    </div>

    <div class="actions">
      <a class="btn back" href="{{ url_for('inicio') }}">← Volver al inicio</a>
    </div>
  </div>

  <script>
    // toggle una carpeta
    document.querySelectorAll('.folder').forEach(f => {
      f.addEventListener('click', () => {
        f.classList.toggle('open');
        const id = f.getAttribute('data-cliente');
        const files = document.querySelector(`.files[data-files-of="${id}"]`);
        if(files){ files.style.display = f.classList.contains('open') ? 'block' : 'none'; }
      });
    });

    // expandir / colapsar todas
    function toggleAll(open){
      document.querySelectorAll('.folder').forEach(f => {
        f.classList.toggle('open', open);
        const id = f.getAttribute('data-cliente');
        const files = document.querySelector(`.files[data-files-of="${id}"]`);
        if(files){ files.style.display = open ? 'block' : 'none'; }
      });
    }

    // filtro por cliente o archivo
    function doFilter(){
      const q = (document.getElementById('q').value || '').trim().toLowerCase();
      const folders = document.querySelectorAll('.folder');
      folders.forEach(f => {
        const id = f.getAttribute('data-cliente');
        const name = f.querySelector('.name')?.innerText.toLowerCase() || '';
        const filesBox = document.querySelector(`.files[data-files-of="${id}"]`);
        let hitFolder = name.includes(q);
        let anyFileShown = false;

        if(filesBox){
          filesBox.querySelectorAll('.file').forEach(file => {
            const text = file.getAttribute('data-file') || '';
            const show = !q || text.includes(q);
            file.style.display = show ? 'flex' : 'none';
            if(show) anyFileShown = true;
          });
        }

        // mostrar carpeta si coincide el nombre o si algún archivo coincidió
        const showFolder = !q || hitFolder || anyFileShown;
        f.style.display = showFolder ? 'flex' : 'none';
        if(filesBox) filesBox.style.display = showFolder && (q ? anyFileShown || hitFolder : f.classList.contains('open')) ? 'block' : 'none';
        if(q && showFolder){ f.classList.add('open'); } // abrir al buscar
        else if(!q){ /* no tocar */ }
      });
    }
  </script>
</body>
</html>
