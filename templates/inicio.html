<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cotizador HSC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --line:#e5e7eb; --brand:#2563eb; --ok:#22c55e; --danger:#ef4444;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI, Roboto, system-ui, -apple-system, sans-serif}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:1.25rem;font-weight:800;letter-spacing:.2px}
    .pill{font-size:.85rem;color:var(--muted)}

    .grid{display:grid;gap:16px}
    @media(min-width:840px){ .grid-2{grid-template-columns:1.2fr .8fr} }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:16px; box-shadow:0 6px 20px rgba(17,24,39,.05);
    }
    .section-title{font-size:1rem;margin:0 0 10px;font-weight:700}
    label{display:block;font-size:.9rem;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{
      width:100%; border:1px solid var(--line); border-radius:12px; padding:12px 12px; font-size:16px;
      background:#fbfdff; outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:560px){ .row-2{grid-template-columns:1fr 1fr} }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 14px; border-radius:12px; border:1px solid var(--line); cursor:pointer; font-weight:700; font-size:15px;
      background:#f9fbff; color:#0f172a;
    }
    .btn:hover{background:#f1f5ff}
    .btn-primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn-primary:hover{filter:brightness(.98)}
    .btn-ok{background:var(--ok); color:#04140a; border-color:transparent}
    .btn-danger{background:var(--danger); color:#fff; border-color:transparent}
    .actions{display:flex;flex-wrap:wrap;gap:10px}

    .flash{
      background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;
      padding:10px 12px; border-radius:12px; margin:12px 0; font-weight:600;
    }

    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px;background:var(--card)}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:12px 12px;border-bottom:1px solid var(--line);text-align:left}
    th{background:#f8fafc;font-weight:700;color:#334155}
    tfoot td{font-weight:800;background:#f8fafc}
    .t-actions .btn{padding:8px 10px;font-size:14px}

    .subtle{color:var(--muted);font-size:.88rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Cotizador HSC</div>
        <div class="pill">Esta vez vamos a vender</div>
      </div>
      <!-- quitamos botones duplicados aqu√≠ -->
    </div>

    {% with mensajes = get_flashed_messages() %}
      {% if mensajes %}
        <div class="flash">
          {% for m in mensajes %}{{ m }}{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Formulario de datos -->
    <form class="grid grid-2" action="{{ url_for('guardar_datos') }}" method="post">
      <div class="card">
        <h3 class="section-title">Cliente y condiciones</h3>

        <label>Cliente</label>
        <select name="cliente" id="cliente" required>
          <option value="">‚Äî Selecciona un cliente ‚Äî</option>
          {% for nombre in clientes %}
            <option value="{{ nombre }}" {% if datos.cliente == nombre %}selected{% endif %}>{{ nombre }}</option>
          {% endfor %}
        </select>

        <div class="actions" style="margin:6px 0 10px">
          <a class="btn" href="{{ url_for('nuevo_cliente') }}">‚ûï Nuevo</a>
          <button class="btn" type="button" id="btnEditarCliente">‚úèÔ∏è Editar</button>
          <a class="btn btn-danger" href="{{ url_for('borrar_cliente') }}">üóëÔ∏è Borrar</a>
          <a class="btn" href="{{ url_for('repositorio') }}">üìÇ Ver cotizaciones guardadas</a> <!-- dejamos 1 sola instancia -->
        </div>

        <label>Atenci√≥n</label>
        <select name="atencion" id="atencion" required></select>

        <label>Direcci√≥n</label>
        <input type="text" name="direccion" id="direccion" value="{{ datos.direccion or '' }}"/>

        <div class="row row-2">
          <div>
            <label>Fecha</label>
            <input type="date" name="fecha" value="{{ datos.fecha or today }}"/>
          </div>
          <div>
            <label>Tiempo de entrega</label>
            <input type="text" name="tiempo" id="tiempo" value="{{ datos.tiempo or '' }}"/>
          </div>
        </div>

        <label>Comentarios o aclaraciones</label>
        <textarea name="comentarios" id="comentarios" rows="3">{{ datos.comentarios or '' }}</textarea>
      </div>

      <div class="card">
        <h3 class="section-title">T√©rminos y folio</h3>

        <label>Anticipo</label>
        <input type="text" name="anticipo" id="anticipo" value="{{ datos.anticipo or '' }}"/>

        <label>Vigencia</label>
        <input type="text" name="vigencia" id="vigencia" value="{{ datos.vigencia or '' }}"/>

        <label>No. Cotizaci√≥n</label>
        <input type="text" name="cotizacion" value="{{ datos.cotizacion or '' }}"/>

        <div class="actions" style="margin-top:8px">
          <button class="btn btn-primary" type="submit">üíæ Guardar datos</button>
          <!-- quitamos vista previa duplicada aqu√≠ -->
        </div>

        <div style="margin-top:12px" class="subtle">
          Al guardar, estos datos se usar√°n para la generaci√≥n del PDF y el env√≠o a Drive.
        </div>
      </div>
    </form>

    <!-- quitamos tarjetas de totales (KPI) -->

    <!-- Agregar partida -->
    <form class="card" action="{{ url_for('agregar') }}" method="post">
      <h3 class="section-title">Agregar partida</h3>
      <div class="row row-2">
        <div style="grid-column:1/-1">
          <label>Descripci√≥n</label>
          <input type="text" name="descripcion" placeholder="Describe la partida‚Ä¶"/>
        </div>
        <div>
          <label>Cantidad</label>
          <input type="number" name="cantidad" step="1" min="1" />
        </div>
        <div>
          <label>Precio</label>
          <input type="number" name="precio" step="0.01" min="0" />
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn" type="submit">‚ûï Agregar</button>
        <a class="btn" href="{{ url_for('vista_previa') }}">üëÅÔ∏è Vista previa</a> <!-- 1 sola instancia -->
        <a class="btn btn-ok" href="{{ url_for('generar_pdf') }}">üìÑ Generar PDF</a>
      </div>
    </form>

    <!-- Lista de partidas -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Total</th>
            <th style="width:220px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for p in partidas %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ p.descripcion }}</td>
            <td style="text-align:center">{{ p.cantidad }}</td>
            <td style="text-align:right">${{ '%.2f'|format(p.precio) }}</td>
            <td style="text-align:right">${{ '%.2f'|format(p.total) }}</td>
            <td class="t-actions">
              <div class="actions">
                <a class="btn" href="{{ url_for('editar', indice=loop.index0) }}">‚úèÔ∏è Editar</a>
                <a class="btn btn-danger" href="{{ url_for('eliminar', indice=loop.index0) }}">üóëÔ∏è Borrar</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3"></td>
            <td style="text-align:right">SUBTOTAL</td>
            <td style="text-align:right">${{ '%.2f'|format(subtotal) }}</td>
            <td></td>
          </tr>
          <tr>
            <td colspan="3"></td>
            <td style="text-align:right">IVA 16%</td>
            <td style="text-align:right">${{ '%.2f'|format(iva) }}</td>
            <td></td>
          </tr>
          <tr>
            <td colspan="3"></td>
            <td style="text-align:right"><strong>TOTAL</strong></td>
            <td style="text-align:right"><strong>${{ '%.2f'|format(total) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="actions" style="margin-top:12px">
      <a class="btn" href="{{ url_for('limpiar') }}">üßπ Limpiar todo</a>
    
    </div>
  </div>

  <!-- Datos clientes embebidos -->
  <script type="application/json" id="clientes-data">
    {{ clientes | tojson | safe }}
  </script>

  <script>
    const clientes = JSON.parse(document.getElementById("clientes-data").textContent);

    document.addEventListener('DOMContentLoaded', () => {
      const selectCliente = document.getElementById('cliente');
      const selectAtencion = document.getElementById('atencion');
      const direccion = document.getElementById('direccion');
      const tiempo = document.getElementById('tiempo');
      const anticipo = document.getElementById('anticipo');
      const vigencia = document.getElementById('vigencia');

      function cargarDatosCliente(nombreCliente){
        const d = clientes[nombreCliente];
        if(!d) return;

        // Atenci√≥n
        selectAtencion.innerHTML = '';
        (d.atencion || []).forEach((persona, i) => {
          const opt = document.createElement('option');
          opt.value = persona;
          opt.textContent = persona;
          if(i === 0) opt.selected = true;
          selectAtencion.appendChild(opt);
        });

        direccion.value = d.direccion || '';
        tiempo.value    = d.tiempo || '';
        anticipo.value  = d.anticipo || '';
        vigencia.value  = d.vigencia || '';
      }

      // Inicial
      if(selectCliente.value){ cargarDatosCliente(selectCliente.value); }

      // Cambio de cliente
      selectCliente.addEventListener('change', () => {
        cargarDatosCliente(selectCliente.value);
      });

      // Bot√≥n Editar cliente -> usa el seleccionado
      const btnEditar = document.getElementById('btnEditarCliente');
      btnEditar.addEventListener('click', () => {
        const c = selectCliente.value;
        if(!c){ alert('Primero selecciona un cliente.'); return; }
        const url = "{{ url_for('editar_cliente', nombre='__NOMBRE__') }}".replace('__NOMBRE__', encodeURIComponent(c));
        window.location.href = url;
      });
    });
  </script>
</body>
</html>
